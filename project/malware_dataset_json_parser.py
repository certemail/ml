import json
import glob
import os
import argparse
from collections import OrderedDict
from pprint import pprint


def enumerate_all_features(path_to_dataset):

    all_features_in_dataset = {}

    # recursively open all files
    for filename in glob.iglob(path_to_dataset + '/**/*.json', recursive=True):
        print("PROCESSING: " + filename)

        with open(filename) as data_file:
            data = json.load(data_file)

            # get all properties for this file
            properties = sorted((data["properties"]).keys())
            print("Properties: " + str(len(properties)))

    
            # add feature and values to dictionary
            for feature in properties:
                print("feature: " + feature)

                if not feature in all_features_in_dataset:
                    # create dict as value if first time seeing feature
                    all_features_in_dataset[feature] =[] 
                    feature_values_str  = data["properties"][feature]
                    feature_values_list = [x for x in feature_values_str.split()]
                    for f_value in feature_values_list:
                        all_features_in_dataset[feature].append(f_value)

                else:
                    feature_values_str  = data["properties"][feature]
                    feature_values_list = [x for x in feature_values_str.split()]
                    for f_value in feature_values_list:
                        all_features_in_dataset[feature].append(f_value)

            print("-------------------------------------")

    #post procesing to remove duplicates - convert to set (keep unique) and then back to list
    for k, v in all_features_in_dataset.items():
        all_features_in_dataset[k] = list(set(v))
        
    return all_features_in_dataset

            #for x in properties:
            #    print(x + "-->" + data["properties"][x])

            #print(*properties, sep='\n')
            #pprint(data)

            ## extract all API calls and place in list
            #apis_str = data["properties"]["api_resolv"]
            #api_list = [x for x in apis_str.split()]
            #print("num APIS : " + str(len(api_list)))
            #print("APIs: " + str(api_list))
            

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument("path_to_tng_data", help="full path to malware training data set")
    args = parser.parse_args()

    all_features = enumerate_all_features(args.path_to_tng_data)
    print(all_features)
    print(len(all_features.keys()))
